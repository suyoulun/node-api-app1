## 搭建高级接口文档

### 技术栈

| 名称         | 描述                                 | 版本号 |
| ------------ | ------------------------------------ | ------ |
| express      | Web 应用框架                         | 4.16.3 |
| mongoose     | 管理mongodb数据库                    | 5.2.15 |
| body-parser  | 路由参数解析工具                     | 1.18.3 |
| gravatar     | 全球公认的头像第三方库               | 1.6.0  |
| bcrypt       | 密码加密（已被替换）                 | 3.0.0  |
| bcryptjs     | 第三方密码加密库，对原有bcrypt的优化 | 2.4.3  |
| jsonwebtoken | token工具                            | 8.4.0  |
| passport     |                                      | 0.4.0  |
| passport-jwt | 验证token                            | 4.0.0  |
|              |                                      |        |



### 使用express框架

1、安装 `express`

```js
const express = require('express');
const bodyParser = require('body-parser');
const app = express();

// 使用body-parser中间件
app.use(bodyParser.urlencoded({extended:false}));
app.use(bodyParser.json());

// 端口号
const port = process.env.PORT || 5000;

// 路由
app.get('/', (req, res) => {
  res.send('Hello World!')
});

// 开启服务器
app.listen(port, () => {
  console.log(`Server runing on port         http://localhost:${port}`);
});
```



### 连接本地mongodb

1、安装 `mongoose`

2、连接配置

**server.js** 

```js
const mongoose = require('mongoose');

// 引入配置 mongodb
const db = require('./config/database').mongoURI;
// 连接 mongodb
mongoose.connect(db, { useNewUrlParser: true })
  .then(() => console.log('MongoDB Connected......'))
  .catch(err => console.log(err));
```

**config/database.js**

```js
if (process.env.NODE_ENV === 'production') {
  module.exports = {
    mongoURL: 'mongodb://test:test123456@ds261072.mlab.com:61072/restful-app-prod'
  }
} else {
  module.exports = {
    mongoURL: 'mongodb://localhost/restful-app'
  }
}
```



### 搭建路由

1、创建路由模块

**routes/api/users.js**

```js
const express = require('express');
const router = express.Router();

/**
 * $route   api/users/test
 * @method  GET
 * @desc    测试接口
 * @access  public
 */
router.get('/test', (req, res) => {
  res.json({msg:'login works'});
});

module.exports = router;
```

2、使用路由模块

**server.js**

```js
// 引入 users.js
const users = require('./routers/api/users');
// 使用routers
app.use('/api/users', users);
```



### 搭建用户登录注册接口

1、创建数据模型 `Schema`

**modules/User.js**

```js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

// 用户数据 Schema
const UserSchema = new Schema({
  name: {
    type: String,
    required: true
  },
  email: {
    type: String,
    required: true
  },
  password: {
    type: String,
    required: true
  },
  avatar: {
    type: String
  },
  date: {
    type: String,
    default: Date.now
  }
});

module.exports = User = mongoose.model('users', UserSchema);
```

2、配置用户注册接口

安装 `bcryptjs`  `gravatar`

**routes/api/users.js**

```js
// @login & register
const express = require('express');
const router = express.Router();
const bcryptjs = require('bcryptjs');
const gravatar = require('gravatar');

// 用户数据模型
const User = require('../../modules/User');

/**
 * $route   api/users/register
 * @method  POST
 * @desc    注册用户
 * @access  public
 */
router.post('/register', (req, res) => {
  // 查询数据库中是否拥有该邮箱
  User.findOne({email: req.body.email})
    .then((user) => {
      if (user) {
        return res.status(400).json({msg: '邮箱已被注册！'});
      } else {
        // 头像处理
        let avatar = gravatar.url(req.body.email, {s: '200', r: 'pg', d: 'mm'});

        // 创建用户
        const newUser = new User({
          name: req.body.name,
          email: req.body.email,
          password: req.body.password,
          avatar
        });

        // 加密密码
        bcryptjs.genSalt(10, (err, salt) => {
          bcryptjs.hash(newUser.password, salt, (err, hash) => {
            if (err) throw err;
            newUser.password = hash;
            newUser.save()
              .then(user => res.json(user))
              .catch(err => console.log(err));
          });
        });
      }
    });
});

module.exports = router;
```

3、用户头像处理

**routes/api/users.js**

```js
const gravatar = require('gravatar');

// 得到头像，保存数据库中
let avatar = gravatar.url(req.body.email, {s: '200', r: 'pg', d: 'mm'});
```

4、配置用户登录接口

**routes/api/users.js**

```js
/**
 * $route  /api/users/login
 * @method  POST
 * @desc    用户登录
 * @return  token jwt passport
 * @access  public
 */
router.post('/login', (req, res) => {
  const {email, password} = req.body;

  // 查询数据库
  User.findOne({email})
    .then(user => {
      if (!user) {
        return res.status(400).json({msg: '用户不存在'})
      }

      // 密码匹配
      bcrypt.compare(password, user.password).then((isMatch) => {
        if (isMatch) {
          res.json({msg: '登录成功'}) // 返回信息将替换成token
        } else {
          res.status(400).json({msg: '密码错误'})
        }
      });
    })
});
```

5、登录成功返回token

安装 `jsonwebtoken`

**routes/api/users.js**

```js
const jwt = require('jsonwebtoken');

.....
          // 密码匹配成功之后返回生成的token
          // jwt.sign('规则', '加密名字', '过期时间', '箭头函数');
          const rule = {id: user.id, name: user.name};
          jwt.sign(rule, 'secret', {expiresIn: 1800}, (err, token) => {
            if (err) throw err;
            res.json({
              success: true,
              token: 'Bearer ' + token // 固定名称
            })
          });
......
# 注意：token字段必须前面加 "Bearer "，否则 passport-jwt 验证不成功。
```



### 验证用户token

安装 `passport、passport-jwt`

1、在主文件初始化 `passport`

  **server.js**

``` js
const passport = require('passport');

const users = require('./routers/api/users'); // 引入包含数据模型的路由模块

// 初始化 passport
app.use(passport.initialize());
require('./config/passport.js')(passport);
# 注意：由于passport中使用到mongoose.model，所以必须要在数据模型创建后执行
```

2、token验证代码块

**config/passport.js**

```js
const mongoose = require('mongoose');
const User = mongoose.model('users');
const keys = require('../config/keys.js');

const JwtStrategy = require('passport-jwt').Strategy;
const ExtractJwt = require('passport-jwt').ExtractJwt;

const opts = {};
opts.jwtFromRequest = ExtractJwt.fromAuthHeaderAsBearerToken();
opts.secretOrKey = keys.secretOrKey;

module.exports = passport => {
  passport.use(new JwtStrategy(opts, (jwt_payload, done) => {
    // console.log(jwt_payload);
    User.findById(jwt_payload.id) // 匹配数据库中的用户
      .then(user => {
        if (user) {
          return done(null, user)
        } else {
          return done(null, false)
        }
      })
      .catch(err => console.log(err))
  }));
};
```

3、路由中使用token验证

**routers/api/users.js**

```js
/**
 * $route  /api/users/current
 * @method  GET
 * @header  Token
 * @desc    获取用户信息
 * @return  用户信息
 * @access  private
 */
router.get('/current', passport.authenticate('jwt', {session:false}), (req, res) => {
  res.json({
    id: req.user.id,
    name: req.user.name,
    email: req.user.email
  })
});
# 注意：在登录时生成的token字段前必须添加字符 "Bearer "，否则验证不成功。
```















## 附录1

### 安装本地mongodb

1. 下载安装

   window系统下载安装包 https://www.mongodb.com/download-center/community

   下载完成之后，安装到C盘：下一步直到finish

2. 创建数据文件夹

   MongoDB 将数据文件夹存储在 db 文件夹下。

   可是这个数据文件夹不会主动创建，在安装完成后须要创建它。请注意，数据文件夹应该放在根文件夹下（如： `C:\` 或者 `D:\` 等）

   在本项目中我们把 data 文件夹创建在 D 盘根目录下，然后在 data 文件夹里再创建 db 文件夹。

   ```bash
   cd C:\
   mkdir data
   cd data
   mkdir db
   cd db
   ```

3. 命令行下执行 MongoDB server

   为了从命令提示等下执行 MongoDBserver，必须从 MongoDB 文件夹的bin文件夹中执行 mongod.exe 文件，如下：

   ```bash
   C:\Program Files\MongoDB\Server\4.0\bin>mongod.exe --dbpath c:\data\db
   ```

   之后，在浏览器地址栏中输入 `localhost:27017`  进行查看。

4. 将 MongoDBserver作为 Windows 服务执行

   此操作将会在windows下建立一个永久性本地服务，在每次开机主动启动 MongoDB 服务。

   ```bash
   C:\Program Files\MongoDB\Server\4.0\bin>mongod.exe --logpath d:\data\logs\mongodb.log --logappend --dbpath d:\data\db --serviceName MongoDB --install
   ```



### 查询本地数据库

在 bin 目录下执行命令，然后就可以使用 mongoDB 语法

```
C:\Program Files\MongoDB\Server\4.0\bin> mongo
或者
C:\Program Files\MongoDB\Server\4.0\bin> .\mongo
```

查询数据库，以下可以查到 admin、config、local、node-app 四个库

```
>show dbs
-----以下是查询结果-----
admin     0.000GB
config    0.000GB
local     0.000GB
node-app  0.000GB
```

进入(使用)某个库，如 node-app

```
> use node-app
-----以下是查询结果-----
switched to db node-app
```

查询数据表，以下查到表 ideas

```
> show collections
-----以下是查询结果-----
ideas
```

查询表数据

```
> db.ideas.find()
-----以下是查询结果-----
{ "_id" : ObjectId("5bcc4c449a9f908b88c17eef"), "title" : "NodeJS", "details" : "学习前 端的后台", "date" : ISODate("2018-10-21T09:52:04.641Z"), "__v" : 0 }
```























































